# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Toronto Asset Safety Radar v2 â€” Daily Pipeline
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# This workflow runs every day at 09:00 EST (14:00 UTC).
# It:
#   1. Installs Python and Node.js
#   2. Runs scrape.py to generate fresh JSON data
#   3. Builds the React app (bundling the new JSON inside)
#   4. Deploys the result to GitHub Pages
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Daily Scrape & Deploy

on:
  # â”€â”€ Scheduled: every day at 09:00 EST (14:00 UTC) â”€â”€
  schedule:
    - cron: '0 14 * * *'

  # â”€â”€ Manual trigger from GitHub UI â”€â”€
  workflow_dispatch:

  # â”€â”€ Also run on pushes to main (for initial deployment) â”€â”€
  push:
    branches: [main]

# Required for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Only one deployment at a time
concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  scrape-build-deploy:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # â”€â”€ 1. Checkout the repository â”€â”€
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup Python (for scraper) â”€â”€
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # â”€â”€ 3. Setup Node.js (for React build) â”€â”€
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # â”€â”€ 4. Run the scraper â”€â”€
      - name: ğŸ” Scrape Toronto Police data
        run: python scrape.py

      # â”€â”€ 5. Verify data files were created â”€â”€
      - name: âœ… Verify data output
        run: |
          echo "â”€â”€ Data files â”€â”€"
          ls -lh public/data/
          echo ""
          echo "â”€â”€ Auto thefts (first 200 chars) â”€â”€"
          head -c 200 public/data/auto_thefts.json || echo "âš  File missing"
          echo ""
          echo "â”€â”€ Bike thefts (first 200 chars) â”€â”€"
          head -c 200 public/data/bike_thefts.json || echo "âš  File missing"

      # â”€â”€ 6. Install npm dependencies â”€â”€
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # â”€â”€ 7. Build the React app â”€â”€
      # The build bundles the JSON files from public/data/ into the dist
      - name: ğŸ—ï¸ Build application
        run: npm run build

      # â”€â”€ 8. Upload to Pages â”€â”€
      - name: ğŸ“„ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      # â”€â”€ 9. Deploy â”€â”€
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
